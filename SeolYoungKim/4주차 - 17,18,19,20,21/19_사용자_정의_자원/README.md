# 19. 사용자 정의 자원 
> - 사용자에게 필요한 자원을 정의해서 사용하는 것 
> - `kubectl`과 같은 기본 쿠버네티스 명령어들과 함께 다룰 수 있음 
> - 사용자 정의 컨트롤러 제공 


## 1) 사용자 정의 컨트롤러
- 사용자 정의 자원 자체는 그저 구조화된 데이터일 뿐 
- 이를 사용하여 원하는 동작을 수행하려면 사용자 정의 컨트롤러를 이용해 API를 만들어야 함 
- 사용자 정의 컨트롤러 를 사용하는 방법 중 유명한 것 
  - Operator 패턴, Knative 서버리스 플랫폼 

### 사용자 정의 컨트롤러를 이용해 API를 만들어야 하는 상황 
- 추가하려는 API가 선언적(Declarative)이어야 함 
- 추가한 사용자 정의 자원을 `kubectl`로 다룰 수 있어야 함 
- 추가한 타입을 쿠버네티스 대시보드같은 UI에서 모니터링할 수 있어야 함
- 기존에 동작 중인 API를 쿠버네티스에 추가하는 것이 아니라 새로운 API를 개발 중임 
- 쿠버네티스의 기본 API 그룹과 네임스페이스 형식을 맞춰 새로운 API를 만들 수 있음 
- 추가하려는 사용자 정의 자원이 쿠버네티스 클러스터 안이나 특정 네임스페이스 안에서만 동작해야 함 
- 쿠버네티스가 제공하는 기본 API 지원 기능들을 활용할 수 있음 


### 주의할 점 
- 추가 저장 공간이 필요함 
- 사용자 정의 컨트롤러에 버그가 있을 경우, 예상치 못한 장애가 발생할 수 있음 


### 선언적 API란?
- API가 작은 오브젝트들의 조합으로 이루어진 형태를 의미 
  - [명령형 프로그래밍 vs 선언적 프로그래밍](https://velog.io/@hyun_sang/%EB%AA%85%EB%A0%B9%ED%98%95-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%EA%B3%BC-%EC%84%A0%EC%96%B8%EC%A0%81-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%EB%B9%84%EA%B5%90)
- 각 오브젝트들은 애플리케이션이나 인프라의 설정을 정의할 뿐, 특정 동작을 하도록 요청하지 않음 
- 정의한 오브젝트는 CRUD를 요청해 동작시키는 것
  - 트랜잭션을 엄수해야 하는 정확한 상태를 명령하는 형식이어서는 안됨 
  - 오브젝트들이 어떨지 바라는 상태만 나타내야 함
- ex
  - 파드 2개를 더 생성하세요 → 시스템에 명령을 요청하는 것 → 선언적이 아님 
    - 일시적인 장애가 발생한다면 사라져벼릴 수 있는 명령 
  - 파드 2개가 실행되어야 합니다 → 선언적 
    - 일시적인 장애가 있떠라도, 나중에 다시 확인하여 파드 개수가 2개가 아닐 경우 2개로 맞출 수 있음 


### 템플릿 및 도구 
- `sample-controller` 템플릿
- `Kubebuilder`: kubernetes-sig에서 관리하는 사용자 정의 컨트롤러 
- `operator-sdk`: 코어 OS에서 오퍼레이터 프레임워크의 일부로 내놓은 사용자 정의 컨트롤러 
- `metacontroller`: GCP에서 제공하는 사용자 정의 컨트롤러 

---

## 2) 사용자 정의 자원과 컨피그맵 
### 컨피그맵을 사용해야 할 때의 조건 
- 형식이 잘 정리된 파일 사용 
- 전체 설정 파일 내용을 컨피그맵에 키 하나로 등록해서 사용 
- 설정 파일의 주 용도가 파드 안 프로그램 실행 
- 쿠버네티스 API가 아닌 파드 안 파일이나 환경 변수의 형태로 설정 파일을 사용 
- 설정 파일이 업데이트되면 디플로이먼트로 롤링 업데이트 해야함 


### 사용자 정의 자원을 사용해야 할 때의 조건 
- 새 자원을 만들거나 업데이트할 때 쿠버네티스 클라이언트 라이브러리와 CLI를 사용 
- `kubectl`을 이용해 자원 사용 
- 오브젝트의 업데이트를 지켜보다가, 다른 오브젝트를 CRUD 하거나 다른 오브젝트가 업데이트되었을 때 사용자 정의 자원을 CRUD하는 자동화를 만들고싶은 상황 
- 오브젝트를 업데이트하는 자동화를 만들고싶은 상황
- 쿠버네티스 API에서 제공하는 `.spec`, `.status`, `.metadata`등의 필드 사용 
- 관리하는 자원이나 다른 자원 모음을 추상화한 오브젝트를 사용 


---

## 3) 사용자 정의 자원 정의하기 
### CRD(CustomResourceDefinitions)
- 템플릿을 만들 수 있음 
  - 템플릿과 원하는 언어로 CRD 컨트롤러를 만들고 관리 
- 쿠버네티스 기본 마스터 컴포넌트만 있으면됨
  - CRD를 관리하는 추가 서비스가 필요 없음
  - 사용자 정의 자원은 `kube-apiserver`가 관리 
- 기본 쿠버네티스 업그레이드와 버그 수정 등에 포함되는 항목
  - 관리가 쉬움

### Aggregated API
- Go 프로그래밍 언어로 바이너리와 이미지를 만들어야 함 
- 추가 서비스를 만들어야 함
- 쿠버네티스 최신 버전과의 호환성을 맞추기 위해 사용자가 만든 소스를 변경해야 할수도 있음
  - 주기적으로 쿠버네티스 소스의 upstream을 가져와 변경 사항을 반영하고, 새로운 API 서버 바이너리를 만드는 작업을 진행해야 함 


---

## 4) 프로메테우스 오퍼레이터 
- 코어 OS의 오퍼레이터
  - 사용자 정의 컨트롤러를 사용하는 대표적인 예
  - 특정 애플리케이션의 생명 주기를 자동으로 관리 
  - 가장 많이 알려진 것이 프로메테우스 


